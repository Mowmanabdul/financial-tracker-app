<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Financial Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        :root {
            --bg-color: #f8f9fa;
            --surface-color: #ffffff;
            --primary-text-color: #0a1023;
            --secondary-text-color: #6c757d;
            --border-color: #dee2e6;
            --primary-brand-rgb: 46, 84, 255;
            --primary-brand: #2e54ff;
            --accent-emerald: #198754;
            --accent-rose: #dc3545;
            --shadow-color: rgba(108, 117, 125, 0.1);
            --shadow-color-hover: rgba(108, 117, 125, 0.15);
            --surface-color-hover: #f1f3f5;
            --transition-speed: 0.3s;
        }

        html[data-theme='dark'] {
            --bg-color: #0a1023;
            --surface-color: #1c2333;
            --primary-text-color: #f8f9fa;
            --secondary-text-color: #adb5bd;
            --border-color: #343a40;
            --primary-brand: #5e81ff;
            --accent-emerald: #20c997;
            --accent-rose: #fd7e14;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --shadow-color-hover: rgba(0, 0, 0, 0.3);
            --surface-color-hover: #343a40;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            padding: 16px;
        }

        #loader-overlay {
            position: fixed; inset: 0; background-color: var(--bg-color);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; transition: opacity 0.5s;
        }
        .spinner {
            width: 56px; height: 56px; border: 5px solid var(--border-color);
            border-bottom-color: var(--primary-brand); border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .container {
            display: grid; grid-template-columns: 350px 1fr; gap: 32px;
            max-width: 1600px; margin: 0 auto;
            opacity: 0; transition: opacity 0.5s;
        }
        .container.loaded { opacity: 1; }

        .sidebar, .main-content { display: flex; flex-direction: column; gap: 32px; }

        .card {
            background-color: var(--surface-color); border-radius: 24px;
            padding: 24px; box-shadow: 0 4px 12px var(--shadow-color);
            transition: background-color var(--transition-speed), box-shadow 0.2s;
            border: 1px solid var(--border-color);
        }
        
        h1 { font-size: 2em; font-weight: 700; color: var(--primary-text-color); }
        h2 { font-size: 1.25em; font-weight: 600; }
        h3 { font-size: 1em; margin-bottom: 8px; color: var(--secondary-text-color); font-weight: 500; }

        .section-header {
            padding-bottom: 12px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color);
        }
        .section-header h2 { margin: 0; padding: 0; border: none; }
        .section-header #period-display, .section-header #history-period-display { font-size: 0.9em; font-weight: 500; color: var(--secondary-text-color); margin-top: 4px; }

        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            gap: 8px; padding: 12px 20px; border-radius: 12px; font-size: 1em;
            font-weight: 600; cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow-color-hover); }
        .btn-primary {
            background: var(--primary-brand); color: white;
        }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background-color: var(--surface-color-hover); color: var(--primary-text-color); border-color: var(--border-color); }
        .btn-secondary:hover { background-color: var(--border-color); }
        .btn-danger { background-color: transparent; color: var(--accent-rose); padding: 0; box-shadow: none; }
        
        #balance { font-size: 3em; font-weight: 800; margin: 4px 0 20px; color: var(--primary-text-color); }
        #balance.negative { color: var(--accent-rose); }

        .form-input, .form-select {
            width: 100%; padding: 12px; border: 1px solid var(--border-color);
            background-color: var(--bg-color); color: var(--primary-text-color);
            border-radius: 8px; font-size: 1em; transition: all 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--primary-brand);
            box-shadow: 0 0 0 3px rgba(var(--primary-brand-rgb), 0.2);
        }
        html[data-theme='dark'] input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        #transaction-list { list-style: none; max-height: 400px; overflow-y: auto; margin-top: 20px; padding: 0; }
        .transaction-item {
            display: grid; grid-template-columns: 40px 1fr auto; align-items: center;
            gap: 16px; padding: 12px; border-radius: 12px; margin-bottom: 12px;
            background-color: var(--surface-color); border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s; opacity: 0; animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .transaction-item:hover { transform: translateY(-3px); box-shadow: 0 4px 12px var(--shadow-color-hover); }
        .transaction-details { grid-column: 2 / 3; }
        .transaction-date { display: none; } /* Hide date by default on mobile */
        .transaction-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .transaction-icon.income { background-color: rgba(25, 135, 84, 0.1); color: var(--accent-emerald); }
        .transaction-icon.expense { background-color: rgba(220, 53, 69, 0.1); color: var(--accent-rose); }
        .transaction-category { font-weight: 600; }
        .transaction-description { font-size: 0.9em; color: var(--secondary-text-color); }
        .transaction-amount { font-size: 1.1em; font-weight: 600; text-align: right; grid-column: 3 / 4; }
        .transaction-amount.income { color: var(--accent-emerald); }
        .transaction-amount.expense { color: var(--accent-rose); }
        .transaction-actions { display: flex; gap: 8px; grid-column: 4 / 5; } /* Actions hidden on mobile */
        .transaction-actions .btn { padding: 8px; background: none; box-shadow: none; border: none; }
        .transaction-actions .btn:hover { background-color: var(--surface-color-hover); }
        .empty-state { text-align: center; padding: 40px 20px; border: 2px dashed var(--border-color); border-radius: 16px; }
        .empty-state h3 { border: none; margin-bottom: 8px; font-size: 1.2em; }
        .overview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .quick-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-item { padding: 20px; background-color: var(--bg-color); border-radius: 12px; }
        .stat-item h4 { font-size: 0.9em; font-weight: 500; color: var(--secondary-text-color); margin-bottom: 8px; }
        .stat-item p { font-size: 1.5em; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .stat-item .income { color: var(--accent-emerald); }
        .stat-item .expense { color: var(--accent-rose); }
        .trend-icon { width: 16px; height: 16px; }
        .trend-icon.up { color: var(--accent-emerald); }
        .trend-icon.down { color: var(--accent-rose); }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; backdrop-filter: blur(8px); }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--surface-color); padding: 24px; border-radius: 20px; width: 90%; max-width: 550px; height: 90vh; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        #modal-overlay.confirmation-modal .modal-content { height: auto; max-width: 400px; text-align: center; }
        #modal-overlay.confirmation-modal .modal-body { padding-right: 0; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-shrink: 0;}
        .modal-close-btn { background: none; border: none; font-size: 2em; cursor: pointer; color: var(--secondary-text-color); transition: color 0.2s; line-height: 1;}
        .modal-close-btn:hover { color: var(--primary-text-color); }
        .modal-form, .modal-body { display: flex; flex-direction: column; gap: 20px; overflow-y: auto; flex-grow: 1; padding-right: 15px; box-sizing: border-box; }
        .modal-buttons { display: flex; gap: 12px; margin-top: 32px; justify-content: flex-end; flex-shrink: 0;}
        .modal-buttons.confirm { justify-content: space-between; margin-top: 24px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .modal-tabs, .view-tabs { display: flex; gap: 8px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; flex-shrink: 0; flex-wrap: wrap; }
        .tab-btn { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: none; background: none; cursor: pointer; font-size: 1em; font-weight: 600; color: var(--secondary-text-color); border-bottom: 2px solid transparent; transition: all 0.2s ease-in-out; flex-shrink: 0; }
        .tab-btn.active { color: var(--primary-brand); border-bottom-color: var(--primary-brand); }
        .tab-btn:hover { color: var(--primary-text-color); }
        .tab-content { display: none; overflow-y: auto; flex-grow: 1; }
        .tab-content.active { display: grid; gap: 20px; }
        .manage-list { display: flex; flex-direction: column; gap: 12px; overflow-wrap: break-word; }
        .list-item { display: grid; grid-template-columns: 1fr auto; align-items: center; padding: 12px 16px; background-color: var(--surface-color-hover); border-radius: 12px; transition: all 0.2s; font-weight: 500; }
        .list-item:hover { background-color: var(--border-color); }
        .list-item .btn { color: var(--secondary-text-color); padding: 0; margin: 0; background: none; box-shadow: none; }
        .progress-item { margin-bottom: 12px; }
        .progress-bar-container { width: 100%; height: 10px; background-color: var(--border-color); border-radius: 5px; overflow: hidden; margin-top: 4px; }
        .progress-bar { height: 100%; width: 0%; border-radius: 5px; background-color: var(--accent-emerald); transition: width 0.5s; }
        .progress-bar.over-budget { background-color: var(--accent-rose); }
        .theme-switch-wrapper { display: flex; align-items: center; justify-content: space-between; }
        .theme-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-color); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-brand); }
        input:checked + .slider:before { transform: translateX(20px); }
        #toast-container { position: fixed; bottom: 80px; right: 20px; z-index: 2001; }
        .toast { background-color: var(--primary-text-color); color: var(--bg-color); padding: 12px 20px; border-radius: 8px; margin-top: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(20px); transition: opacity 0.3s, transform 0.3s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background-color: var(--accent-rose); }
        .insights-list { list-style: none; padding: 0; margin: 0; }
        .insights-list li { font-size: 1em; color: var(--primary-text-color); background-color: var(--surface-color-hover); padding: 12px 16px; border-radius: 10px; margin-bottom: 12px; }
        .goal-allocation-section { border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-top: 16px; }
        .insight-carousel-container { position: relative; display: flex; align-items: center; justify-content: center; padding: 16px 0; height: 80px; }
        .insight-carousel-item { font-size: 1.1em; text-align: center; color: var(--primary-text-color); padding: 0 20px; transition: opacity 0.5s ease-in-out; opacity: 0; position: absolute; width: 100%; }
        .insight-carousel-item.active { opacity: 1; }
        .carousel-btn { background: none; border: none; font-size: 1.5em; color: var(--secondary-text-color); cursor: pointer; position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; }
        .carousel-btn.prev { left: 10px; }
        .carousel-btn.next { right: 10px; }
        .call-to-action-card { display: flex; justify-content: center; margin-top: 20px; }
        
        /* --- NEW PERSONALIZED HEADER --- */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .app-header-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-text-color);
            font-weight: 600;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        .welcome-message h4 {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--primary-text-color);
        }
        .welcome-message p {
            font-size: 0.9em;
            color: var(--secondary-text-color);
        }
        #settings-btn {
             background-color: var(--surface-color-hover);
             border: 1px solid var(--border-color);
             width: 44px; height: 44px;
             padding: 0;
        }

        /* --- MOBILE-FIRST IMPROVEMENTS --- */
        .bottom-nav {
            display: none; /* Hidden by default */
            position: fixed;
            bottom: 0; left: 0; right: 0;
            height: 65px;
            background-color: var(--surface-color);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 12px var(--shadow-color);
            z-index: 999;
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--secondary-text-color);
            transition: color 0.2s;
            font-size: 0.7em;
            font-weight: 500;
            gap: 4px;
        }
        .bottom-nav-item .icon-outline { display: block; }
        .bottom-nav-item .icon-filled { display: none; }
        .bottom-nav-item.active .icon-outline { display: none; }
        .bottom-nav-item.active .icon-filled { display: block; }

        .bottom-nav-item.active, .bottom-nav-item:hover { color: var(--primary-brand); }
        .bottom-nav-item#mobile-add-btn {
            color: white;
            font-size: 1.5em;
            margin: -20px 0 0;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-brand);
            box-shadow: 0 4px 12px rgba(var(--primary-brand-rgb), 0.4);
            flex-grow: 0;
        }
        .mobile-view { display: none; }
        .mobile-view.active { display: flex; flex-direction: column; gap: 24px; }
        
        /* --- MEDIA QUERIES --- */
        @media (min-width: 1201px) {
            .mobile-view { display: flex; flex-direction: column; gap: 32px; }
            .app-header { display: none; } /* Hide mobile header on desktop */
        }
        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            body { padding: 16px; padding-bottom: 80px; }
            .bottom-nav { display: flex; align-items: flex-start; }
            .main-content { gap: 0; }
        }
        @media (max-width: 768px) {
            .overview-grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.3em; }
            #balance { font-size: 2.8em; }
            .transaction-item {
                grid-template-columns: 40px 1fr auto;
                position: relative;
                padding-right: 50px;
            }
             .transaction-actions {
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                display: flex;
                flex-direction: column;
            }
        }
        @media (max-width: 640px) {
            .transaction-filters { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="loader-overlay"><div class="spinner"></div></div>

<div class="container" id="app-container">
    <aside class="sidebar">
        <div id="welcome-card" class="card" style="display: none;">
            <h2>Welcome!</h2>
            <p style="color: var(--secondary-text-color); margin-bottom: 20px;">
                This is your personal financial dashboard. Get started by adding your first transaction.
            </p>
            <button id="welcome-add-btn" class="btn btn-primary">
                Add First Transaction
            </button>
        </div>
        <div class="card" id="desktop-main-card">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h1>Dashboard</h1>
            </div>
            <div class="balance-display">
                <h3>Current Balance</h3>
                <p id="balance">$0.00</p>
            </div>
            <div style="display: grid; gap: 12px;">
                <button id="add-transaction-btn" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    New Transaction
                </button>
                <button id="manage-data-btn" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>
                    Manage Data
                </button>
            </div>
        </div>
        <div class="card" id="desktop-budgets-card">
            <h2>Budgets</h2>
            <div id="budgets-summary-container"></div>
        </div>
        <div class="card" id="desktop-goals-card">
            <h2>Goals</h2>
            <div id="goals-summary-container"></div>
        </div>
    </aside>

    <main class="main-content">
        <!-- NEW HEADER FOR MOBILE -->
        <header class="app-header">
            <div class="app-header-user">
                <div class="user-avatar">
                    <img id="user-avatar-img" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIj48L3BhdGg+PGNpcmNsZSBjeD0iMTIiIGN5PSI3IiByPSI0Ij48L2NpcmNsZT48L3N2Zz4=" alt="User Avatar">
                </div>
                <div class="welcome-message">
                    <h4>Welcome back!</h4>
                </div>
            </div>
            <button id="settings-btn" class="btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83l-2.6 2.6a2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1.03-1.03c-.6-.24-1.23-.3-1.93-.16a1.65 1.65 0 0 0-1.82-.33l-.06-.06a2 2 0 0 1-2.83 0l-2.6-2.6a2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0 1.03-1.03c.24-.6.3-1.23.16-1.93a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83l2.6-2.6a2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33 1.65 1.65 0 0 0 1.03-1.03c.6-.24 1.23-.3 1.93-.16a1.65 1.65 0 0 0 1.82.33l.06.06a2 2 0 0 1 2.83 0l2.6 2.6a2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82 1.65 1.65 0 0 0-1.03 1.03c-.24.6-.3 1.23-.16 1.93z"></path></svg>
            </button>
        </header>

        <div id="mobile-home-view" class="mobile-view">
             <div class="card">
                <div class="balance-display">
                    <h3>Current Balance</h3>
                    <p id="mobile-balance">$0.00</p>
                </div>
             </div>
             <div class="card" id="upcoming-bills-card" style="display:none;">
                <div class="section-header"><h2>Upcoming Bills</h2></div>
                <div id="upcoming-bills-container"></div>
            </div>
             <div class="card">
                <h2>Budgets</h2>
                <div id="mobile-budgets-summary-container"></div>
            </div>
            <div class="card">
                <h2>Goals</h2>
                <div id="mobile-goals-summary-container"></div>
            </div>
        </div>
        
        <div id="mobile-dashboard-view" class="mobile-view">
             <div class="card" id="subscription-tracker-card" style="display:none;">
                <div class="section-header"><h2>Monthly Subscriptions</h2></div>
                <div id="subscription-tracker-container"></div>
            </div>
            <div class="card" id="insights-card" style="display:none;">
                <div class="section-header" style="text-align: center;"><h2>Smarter Insights</h2></div>
                <div id="insight-carousel-container" class="insight-carousel-container">
                    <button id="carousel-prev" class="carousel-btn prev" style="display:none;">&lt;</button>
                    <div id="insights-content" style="width: 100%;"></div>
                    <button id="carousel-next" class="carousel-btn next" style="display:none;">&gt;</button>
                </div>
            </div>
            <div class="card" id="forecast-card" style="display:none;">
                <div class="section-header"><h2>Financial Forecast</h2></div>
                <div class="chart-container" style="height: 300px;"><canvas id="forecast-chart"></canvas></div>
            </div>
            <div class="card" id="overview-card">
                <div class="section-header">
                    <h2>Financial Overview</h2>
                    <div id="period-display"></div>
                </div>
                 <div class="quick-stats" id="quick-stats"></div>
                <div class="overview-grid">
                    <div class="chart-container" style="height: 300px;"><canvas id="expense-breakdown-chart"></canvas></div>
                    <div class="chart-container" style="height: 300px;"><canvas id="income-expense-chart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="mobile-history-view" class="mobile-view">
             <div class="card">
                <div class="section-header">
                    <h2>Transaction History</h2>
                    <div id="history-period-display"></div>
                </div>
                <div class="transaction-filters" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <input type="text" id="search-input" class="form-input" placeholder="Search transactions..." style="grid-column: 1 / -1;">
                    <select id="month-filter" class="form-select"></select>
                    <select id="year-filter" class="form-select"></select>
                </div>
                <ul id="transaction-list" class="transaction-list"></ul>
            </div>
        </div>

        <div id="mobile-manage-view" class="mobile-view">
            <div class="card">
                <div class="section-header">
                    <h2>Manage Data</h2>
                </div>
                <div id="manage-view-content">
                    <!-- Content will be injected by JavaScript -->
                </div>
            </div>
        </div>
    </main>
</div>

<nav class="bottom-nav">
    <button class="bottom-nav-item active" data-view="mobile-home-view">
        <span class="icon-outline"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></span>
        <span class="icon-filled"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></span>
        <span>Home</span>
    </button>
    <button class="bottom-nav-item" data-view="mobile-dashboard-view">
        <span class="icon-outline"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></span>
        <span class="icon-filled"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></span>
        <span>Dashboard</span>
    </button>
    <button class="bottom-nav-item" id="mobile-add-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>
    <button class="bottom-nav-item" data-view="mobile-history-view">
       <span class="icon-outline"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg></span>
       <span class="icon-filled"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg></span>
        <span>History</span>
    </button>
     <button class="bottom-nav-item" data-view="mobile-manage-view">
       <span class="icon-outline"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></span>
       <span class="icon-filled"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg></span>
        <span>Manage</span>
    </button>
</nav>

<!-- Modals are kept for pop-up actions like adding a transaction -->
<div id="modal-overlay" class="modal-overlay">
    <div id="modal-content" class="modal-content">
        <div class="modal-header">
            <h2 id="modal-title" style="border: none; margin: 0;"></h2>
            <button id="modal-close-btn" class="modal-close-btn">&times;</button>
        </div>
        <div id="modal-body" class="modal-body"></div>
    </div>
</div>

<div id="confirmation-modal-overlay" class="modal-overlay">
    <div class="modal-content confirmation-modal-content">
        <div class="modal-header">
            <h2 id="confirmation-modal-title">Please Confirm</h2>
            <button id="confirmation-modal-close-btn" class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmation-message"></p>
            <div class="modal-buttons confirm">
                <button id="confirm-cancel" class="btn btn-secondary">Cancel</button>
                <button id="confirm-ok" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>
</div>

<div id="add-goal-savings-modal-overlay" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="add-goal-savings-title">Add Savings to Goal</h2>
            <button id="add-goal-savings-close-btn" class="modal-close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <p>Enter the amount you wish to contribute to <strong id="goal-name-display"></strong>.</p>
            <form id="add-goal-savings-form">
                <div class="form-group">
                    <label for="add-goal-savings-amount">Amount</label>
                    <input type="number" id="add-goal-savings-amount" class="form-input" step="0.01" required min="0">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" id="add-goal-savings-cancel">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', async () => {

        const App = {
            state: {
                uid: null, data: { transactions: [], categories: [], budgets: [], goals: [], recurringTransactions: [], settings: { currencySymbol: '$', darkMode: false, lastRecurringCheck: null, profilePicture: null, reminderDays: 3 }, },
                charts: {}, currentEditId: null, unsubscribe: null, onConfirm: null, insights: [], currentInsightIndex: 0
            },
            async init() {
                try {
                    await FirebaseStore.init();
                    this.bindEvents();
                    this.initInsightCarousel();
                    UI.initMobileNav(); 
                } catch (error) {
                    console.error("Initialization failed:", error);
                    const loader = document.getElementById('loader-overlay');
                    if (loader) loader.innerHTML = "Failed to load database. Please ensure the environment is configured correctly.";
                }
            },
            bindEvents() {
                document.getElementById('add-transaction-btn').addEventListener('click', () => UI.showModal('transaction'));
                document.getElementById('manage-data-btn').addEventListener('click', () => UI.showModal('manage'));
                document.getElementById('mobile-add-btn').addEventListener('click', () => UI.showModal('transaction'));
                
                document.getElementById('settings-btn').addEventListener('click', () => UI.showModal('settings'));
                
                const modalCloseBtn = document.getElementById('modal-close-btn');
                if(modalCloseBtn) modalCloseBtn.addEventListener('click', () => UI.hideModal());
                
                document.getElementById('modal-overlay').addEventListener('click', (e) => e.target.id === 'modal-overlay' && UI.hideModal());
                document.getElementById('search-input').addEventListener('input', () => UI.render());
                document.getElementById('month-filter').addEventListener('change', () => UI.render());
                document.getElementById('year-filter').addEventListener('change', () => UI.render());
                const welcomeAddBtn = document.getElementById('welcome-add-btn');
                if (welcomeAddBtn) welcomeAddBtn.addEventListener('click', () => UI.showModal('transaction'));
                
                const addGoalCloseBtn = document.getElementById('add-goal-savings-close-btn');
                if(addGoalCloseBtn) addGoalCloseBtn.addEventListener('click', () => UI.hideAddGoalSavingsModal());

                const addGoalCancelBtn = document.getElementById('add-goal-savings-cancel');
                if(addGoalCancelBtn) addGoalCancelBtn.addEventListener('click', () => UI.hideAddGoalSavingsModal());
                
                const addGoalForm = document.getElementById('add-goal-savings-form');
                if(addGoalForm) addGoalForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const amount = parseFloat(form.elements['add-goal-savings-amount'].value);
                    const goalId = parseFloat(form.dataset.goalId);
                    if (isNaN(amount) || amount <= 0) {
                        UI.showToast('Please enter a valid amount.', 'error');
                        return;
                    }
                    const goalToUpdate = App.state.data.goals.find(g => g.id === goalId);
                    if (goalToUpdate) {
                        goalToUpdate.current += amount;
                        FirebaseStore.save();
                        UI.hideAddGoalSavingsModal();
                        UI.showToast(`Added ${UI.formatCurrency(amount)} to ${goalToUpdate.name}`, 'success');
                    }
                });

                const confirmCloseBtn = document.getElementById('confirmation-modal-close-btn');
                if(confirmCloseBtn) confirmCloseBtn.addEventListener('click', () => UI.hideConfirmationModal());

                const confirmCancel = document.getElementById('confirm-cancel');
                if(confirmCancel) confirmCancel.addEventListener('click', () => UI.hideConfirmationModal());

                const confirmOk = document.getElementById('confirm-ok');
                if(confirmOk) confirmOk.addEventListener('click', () => {
                    if (App.state.onConfirm) App.state.onConfirm();
                    UI.hideConfirmationModal();
                });
            },
            initInsightCarousel() {
                 const prevBtn = document.getElementById('carousel-prev');
                const nextBtn = document.getElementById('carousel-next');

                prevBtn.addEventListener('click', () => {
                    App.state.currentInsightIndex = (App.state.currentInsightIndex - 1 + App.state.insights.length) % App.state.insights.length;
                    UI.renderInsights();
                });
                
                nextBtn.addEventListener('click', () => {
                    App.state.currentInsightIndex = (App.state.currentInsightIndex + 1) % App.state.insights.length;
                    UI.renderInsights();
                });
            }
        };

        const FirebaseStore = {
            db: null, auth: null,
            async init() {
                 const firebaseConfig = {
                    apiKey: "AIzaSyD7O8tdEWtIaAEmminEGeA-CdS5MVCrqnk",
                    authDomain: "financial-application-2dca6.firebaseapp.com",
                    projectId: "financial-application-2dca6",
                    storageBucket: "financial-application-2dca6.appspot.com",
                    messagingSenderId: "415635444957",
                    appId: "1:415635444957:web:37040ea2f5bfac665a3734",
                    measurementId: "G-MT4HCYFJ3L"
                };
                const appId = 'default-financial-tracker';

                if (!firebaseConfig) {
                    throw new Error("Firebase config not found or invalid.");
                }
                const app = initializeApp(firebaseConfig);
                this.db = getFirestore(app);
                this.auth = getAuth(app);
                return new Promise((resolve, reject) => {
                    onAuthStateChanged(this.auth, async (user) => {
                        if (user) {
                            App.state.uid = user.uid;
                            this.attachSnapshotListener(appId);
                            resolve(user);
                        } else {
                            try {
                                await signInAnonymously(this.auth);
                            } catch (error) {
                                console.error("Anonymous authentication failed:", error);
                                reject(error);
                            }
                        }
                    });
                });
            },
            attachSnapshotListener(appId) {
                if (App.state.unsubscribe) App.state.unsubscribe();
                const docRef = doc(this.db, 'artifacts', appId, 'users', App.state.uid);
                App.state.unsubscribe = onSnapshot(docRef, (docSnap) => {
                    const defaultState = {
                        transactions: [], categories: ['Groceries', 'Rent', 'Salary', 'Utilities', 'Entertainment'],
                        budgets: [], goals: [], recurringTransactions: [],
                        settings: { currencySymbol: '$', darkMode: false, lastRecurringCheck: null, profilePicture: null, reminderDays: 3 },
                    };
                    if (docSnap.exists()) App.state.data = { ...defaultState, ...docSnap.data() };
                    else { App.state.data = defaultState; this.save(); }
                    
                    this.processRecurringTransactions();

                    UI.render();
                    const loader = document.getElementById('loader-overlay');
                    if (loader) { loader.style.opacity = '0'; setTimeout(() => loader.remove(), 500); }
                    document.getElementById('app-container').classList.add('loaded');
                });
            },
            async save() {
                const appId = 'default-financial-tracker';
                if (!App.state.uid) return;
                const docRef = doc(this.db, 'artifacts', appId, 'users', App.state.uid);
                try {
                    await runTransaction(this.db, async (transaction) => {
                        transaction.set(docRef, JSON.parse(JSON.stringify(App.state.data)));
                    });
                } catch (e) { console.error("Transaction failed: ", e); }
            },
            processRecurringTransactions() {
                const { DateTime } = window.luxon;
                const now = DateTime.now();
                const lastCheck = App.state.data.settings.lastRecurringCheck
                    ? DateTime.fromISO(App.state.data.settings.lastRecurringCheck)
                    : now.minus({ months: 1 });

                if (now.month === lastCheck.month && now.year === lastCheck.year) {
                    return;
                }

                const recurring = App.state.data.recurringTransactions || [];
                let newTransactionsCreated = false;

                recurring.forEach(rt => {
                    const dayOfMonth = parseInt(rt.day);
                    if (dayOfMonth <= now.day) {
                        const transactionDate = now.set({ day: dayOfMonth }).toISODate();
                        const alreadyExists = App.state.data.transactions.some(
                            t => t.recurringId === rt.id && t.date === transactionDate
                        );
                        
                        if (!alreadyExists) {
                            App.state.data.transactions.push({
                                id: Date.now() + Math.random(),
                                type: rt.type, amount: rt.amount, category: rt.category,
                                description: `(Recurring) ${rt.description}`, date: transactionDate,
                                recurringId: rt.id
                            });
                            newTransactionsCreated = true;
                        }
                    }
                });

                if (newTransactionsCreated) {
                    App.state.data.settings.lastRecurringCheck = now.toISODate();
                    this.save();
                }
            },
            getFilteredTransactions() {
                const selectedMonth = document.getElementById('month-filter').value;
                const selectedYear = document.getElementById('year-filter').value;
                const searchQuery = document.getElementById('search-input').value.toLowerCase();
                const { DateTime } = window.luxon;
                return (App.state.data.transactions || []).filter(t => {
                    const transactionDate = DateTime.fromISO(t.date);
                    if (!transactionDate.isValid) return false;
                    const monthMatches = selectedMonth === 'all' || transactionDate.month.toString() === selectedMonth;
                    const yearMatches = selectedYear === 'all' || transactionDate.year.toString() === selectedYear;
                    const searchMatches = (t.description || '').toLowerCase().includes(searchQuery) || (t.category || '').toLowerCase().includes(searchQuery);
                    return monthMatches && yearMatches && searchMatches;
                }).sort((a, b) => new Date(b.date) - new Date(a.date));
            },
        };

        const UI = {
             initMobileNav() {
                const nav = document.querySelector('.bottom-nav');
                if (!nav) return;
                
                nav.addEventListener('click', (e) => {
                    const navItem = e.target.closest('.bottom-nav-item');
                    if (!navItem || !navItem.dataset.view) return;
                    
                    this.switchMobileView(navItem.dataset.view);

                    nav.querySelectorAll('.bottom-nav-item').forEach(item => item.classList.remove('active'));
                    navItem.classList.add('active');
                });

                if (window.innerWidth <= 1200) {
                    this.switchMobileView('mobile-home-view');
                } else {
                     document.querySelectorAll('.mobile-view').forEach(view => {
                         view.classList.add('active');
                         view.style.display = 'flex';
                     });
                }
            },
            switchMobileView(viewId) {
                document.querySelectorAll('.mobile-view').forEach(view => {
                    view.classList.remove('active');
                });
                const activeView = document.getElementById(viewId);
                if(activeView) activeView.classList.add('active');
            },
            render() {
                this.handleOnboarding();
                this.applyTheme();
                this.renderAvatar();
                this.renderBalance();
                this.populateFilters();
                this.renderTransactionList();
                this.renderCharts();
                this.renderSummaries();
                this.renderQuickStats();
                this.renderPeriodDisplay();
                this.renderInsights();
                this.renderForecast();
                this.renderManageView();
                this.renderSubscriptionTracker(); 
                this.renderUpcomingBills();
            },
            renderUpcomingBills() {
                const container = document.getElementById('upcoming-bills-container');
                const card = document.getElementById('upcoming-bills-card');
                const reminderDays = App.state.data.settings.reminderDays || 3;
                const recurringExpenses = (App.state.data.recurringTransactions || []).filter(rt => rt.type === 'expense');
                
                if (recurringExpenses.length === 0) {
                    card.style.display = 'none';
                    return;
                }

                const { DateTime } = window.luxon;
                const now = DateTime.now();
                const upcoming = [];

                recurringExpenses.forEach(bill => {
                    const dayOfMonth = parseInt(bill.day);
                    let dueDate = now.set({ day: dayOfMonth });
                    
                    if (now.day > dayOfMonth) {
                        dueDate = now.plus({ months: 1 }).set({ day: dayOfMonth });
                    }
                    
                    const diff = dueDate.diff(now, 'days').as('days');

                    if (diff >= 0 && diff <= reminderDays) {
                        upcoming.push({ ...bill, dueDate, diff });
                    }
                });

                if (upcoming.length === 0) {
                    card.style.display = 'none';
                    return;
                }
                
                card.style.display = 'block';
                upcoming.sort((a,b) => a.diff - b.diff);

                let html = '<div class="manage-list">';
                upcoming.forEach(bill => {
                    let dueText = `in ${Math.ceil(bill.diff)} days`;
                    if (Math.ceil(bill.diff) === 0) dueText = 'today';
                    if (Math.ceil(bill.diff) === 1) dueText = 'tomorrow';

                    html += `
                        <div class="list-item">
                            <span>${bill.description}</span>
                            <span style="text-align: right;">
                                <strong style="display: block;">${this.formatCurrency(bill.amount)}</strong>
                                <small>due ${dueText}</small>
                            </span>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            },
            renderSubscriptionTracker() {
                const container = document.getElementById('subscription-tracker-container');
                const card = document.getElementById('subscription-tracker-card');
                const subscriptions = (App.state.data.recurringTransactions || []).filter(rt => rt.type === 'expense');
                
                if (subscriptions.length === 0) {
                    card.style.display = 'none';
                    return;
                }

                card.style.display = 'block';
                const total = subscriptions.reduce((sum, sub) => sum + sub.amount, 0);

                let html = '<div class="manage-list">';
                subscriptions.forEach(sub => {
                    html += `
                        <div class="list-item">
                            <span>${sub.description}</span>
                            <span style="font-weight: 600;">${this.formatCurrency(sub.amount)}</span>
                        </div>
                    `;
                });
                html += '</div>';
                html += `
                    <div style="text-align: right; margin-top: 16px; font-weight: 700; font-size: 1.1em;">
                        Total: ${this.formatCurrency(total)} / month
                    </div>
                `;
                container.innerHTML = html;
            },
            renderAvatar() {
                const avatarImg = document.getElementById('user-avatar-img');
                const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIj48L3BhdGg+PGNpcmNsZSBjeD0iMTIiIGN5PSI3IiByPSI0Ij48L2NpcmNsZT48L3N2Zz4=';
                if (avatarImg) {
                    avatarImg.src = App.state.data.settings.profilePicture || defaultAvatar;
                }
            },
            renderManageView() {
                const container = document.getElementById('manage-view-content');
                if (container) {
                    container.innerHTML = this.getManageContentHTML();
                    this.bindManageViewEvents(container);
                }
            },
            handleOnboarding() {
                const hasTransactions = App.state.data.transactions && App.state.data.transactions.length > 0;
                document.getElementById('welcome-card').style.display = hasTransactions ? 'none' : 'block';
                document.getElementById('overview-card').style.display = hasTransactions ? 'block' : 'none';
                
                document.getElementById('desktop-main-card').style.display = hasTransactions ? 'block' : 'none';
                document.getElementById('desktop-budgets-card').style.display = hasTransactions ? 'block' : 'none';
                document.getElementById('desktop-goals-card').style.display = hasTransactions ? 'block' : 'none';
                
                document.getElementById('insights-card').style.display = hasTransactions ? 'block' : 'none';
                document.getElementById('forecast-card').style.display = hasTransactions ? 'block' : 'none';
            },
            applyTheme() {
                const theme = App.state.data.settings.darkMode ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', theme);
                
                const chartFontColor = theme === 'dark' ? '#94a3b8' : '#64748b';
                Chart.defaults.color = chartFontColor;
                Chart.defaults.borderColor = theme === 'dark' ? '#1e293b' : '#e2e8f0';

                Object.values(App.state.charts).forEach(chart => {
                    if (chart) {
                        chart.options.plugins.legend.labels.color = chartFontColor;
                        chart.options.plugins.title.color = chartFontColor;
                        if(chart.options.scales && chart.options.scales.x) chart.options.scales.x.ticks.color = chartFontColor;
                        if(chart.options.scales && chart.options.scales.y) chart.options.scales.y.ticks.color = chartFontColor;
                        chart.update();
                    }
                });
            },
            renderBalance() {
                const balanceEl = document.getElementById('balance');
                const mobileBalanceEl = document.getElementById('mobile-balance');
                const total = (App.state.data.transactions || []).reduce((acc, t) => acc + (t.type === 'income' ? t.amount : -t.amount), 0);
                const formattedTotal = this.formatCurrency(total);

                if (balanceEl) {
                    balanceEl.textContent = formattedTotal;
                    balanceEl.classList.toggle('negative', total < 0);
                }
                if (mobileBalanceEl) {
                    mobileBalanceEl.textContent = formattedTotal;
                    mobileBalanceEl.classList.toggle('negative', total < 0);
                }
            },
            renderTransactionList() {
                const listEl = document.getElementById('transaction-list');
                const filtered = FirebaseStore.getFilteredTransactions();
                if (filtered.length === 0) {
                    listEl.innerHTML = this.getEmptyStateHTML('No Transactions Found', 'Add a new transaction to get started.', 'add-transaction-btn-empty');
                    document.getElementById('add-transaction-btn-empty')?.addEventListener('click', () => this.showModal('transaction'));
                    return;
                }
                listEl.innerHTML = filtered.map((t, index) => {
                    const icon = t.type === 'income'
                        ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m-7-7h14"/></svg>`
                        : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/></svg>`;
                    const formattedDate = window.luxon.DateTime.fromISO(t.date).toFormat('MMM dd, yyyy');
                    return `
                        <li class="transaction-item" data-id="${t.id}" style="animation-delay: ${index * 0.05}s">
                            <div class="transaction-icon ${t.type}">${icon}</div>
                            <div class="transaction-details">
                                <span class="transaction-category">${t.category}</span>
                                <p class="transaction-description">${t.description || 'No description'}</p>
                            </div>
                            <span class="transaction-amount ${t.type}">${t.type === 'income' ? '+' : '-'}${this.formatCurrency(t.amount)}</span>
                            <div class="transaction-actions">
                                <button class="btn edit-btn" title="Edit"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
                                <button class="btn delete-btn" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                            </div>
                        </li>`;
                }).join('');
                listEl.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => this.showModal('transaction', e.target.closest('li').dataset.id)));
                listEl.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    const id = parseFloat(e.target.closest('li').dataset.id);
                    this.showConfirmationModal('Are you sure you want to delete this transaction?', () => {
                        App.state.data.transactions = App.state.data.transactions.filter(t => t.id !== id);
                        FirebaseStore.save();
                        this.showToast('Transaction deleted', 'success');
                    });
                }));
            },
            renderSummaries() {
                const expensesByCategory = FirebaseStore.getFilteredTransactions().filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
                
                const budgetsContainer = document.getElementById('budgets-summary-container');
                const mobileBudgetsContainer = document.getElementById('mobile-budgets-summary-container');
                const budgets = App.state.data.budgets || [];
                let budgetsHTML;
                if (budgets.length === 0) {
                    budgetsHTML = this.getEmptyStateHTML('No Budgets Set', 'Create budgets to track your spending.', null);
                } else {
                    budgetsHTML = budgets.map(b => {
                        const spent = expensesByCategory[b.category] || 0;
                        const percentage = b.limit > 0 ? Math.min((spent / b.limit) * 100, 100) : 0;
                        const isOver = spent > b.limit;
                        return `<div class="progress-item"><span>${b.category}: ${this.formatCurrency(spent)} / ${this.formatCurrency(b.limit)}</span><div class="progress-bar-container"><div class="progress-bar ${isOver ? 'over-budget' : ''}" style="width: ${percentage}%;"></div></div></div>`;
                    }).join('');
                }
                if (budgetsContainer) budgetsContainer.innerHTML = budgetsHTML;
                if (mobileBudgetsContainer) mobileBudgetsContainer.innerHTML = budgetsHTML;
                
                const goalsContainer = document.getElementById('goals-summary-container');
                const mobileGoalsContainer = document.getElementById('mobile-goals-summary-container');
                const goals = App.state.data.goals || [];
                let goalsHTML;
                if (goals.length === 0) {
                    goalsHTML = this.getEmptyStateHTML('No Goals Set', 'Set financial goals to work towards.', null);
                } else {
                    goalsHTML = goals.map(g => {
                        const percentage = g.target > 0 ? Math.min((g.current / g.target) * 100, 100) : 0;
                        return `<div class="progress-item"><span>${g.name}: ${this.formatCurrency(g.current)} / ${this.formatCurrency(g.target)}</span><div class="progress-bar-container"><div class="progress-bar" style="width: ${percentage}%;"></div></div></div>`;
                    }).join('');
                }
                if (goalsContainer) goalsContainer.innerHTML = goalsHTML;
                if (mobileGoalsContainer) mobileGoalsContainer.innerHTML = goalsHTML;

            },
            renderQuickStats() {
                const container = document.getElementById('quick-stats');
                const filtered = FirebaseStore.getFilteredTransactions();
                const totalIncome = filtered.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const totalExpense = filtered.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const netChange = totalIncome - totalExpense;
                
                const { DateTime } = window.luxon;
                const now = DateTime.now();
                const lastMonth = now.minus({ months: 1 });
                const lastMonthTransactions = App.state.data.transactions.filter(t => DateTime.fromISO(t.date).month === lastMonth.month && DateTime.fromISO(t.date).year === lastMonth.year);
                const lastMonthIncome = lastMonthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const lastMonthExpense = lastMonthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const lastMonthNetChange = lastMonthIncome - lastMonthExpense;

                let trendIcon = '';
                if (netChange > lastMonthNetChange) {
                    trendIcon = `<svg class="trend-icon up" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>`;
                } else if (netChange < lastMonthNetChange) {
                    trendIcon = `<svg class="trend-icon down" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
                }
                
                container.innerHTML = `
                    <div class="stat-item"><h4>Total Income</h4><p class="income">${this.formatCurrency(totalIncome)}</p></div>
                    <div class="stat-item"><h4>Total Expense</h4><p class="expense">${this.formatCurrency(totalExpense)}</p></div>
                    <div class="stat-item"><h4>Net Savings</h4><p class="${netChange >= 0 ? 'income' : 'expense'}">${this.formatCurrency(netChange)} ${trendIcon}</p></div>
                `;
            },
            renderCharts() {
                const isDarkMode = App.state.data.settings.darkMode;
                const filtered = FirebaseStore.getFilteredTransactions();
                const expenses = filtered.filter(t => t.type === 'expense');
                const income = filtered.filter(t => t.type === 'income');
                const expenseData = expenses.reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
                const expenseLabels = Object.keys(expenseData);
                const expenseValues = Object.values(expenseData);
                const doughnutColors = isDarkMode
                    ? ['#fb7185', '#fdba74', '#fde047', '#bef264', '#86efac', '#67e8f9', '#7dd3fc', '#a5b4fc', '#c4b5fd', '#f0abfc', '#f9a8d4']
                    : ['#f43f5e', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#22c55e', '#10b981', '#06b6d4', '#0ea5e9', '#3b82f6', '#8b5cf6'];
                this.createChart('expense-breakdown-chart', 'doughnut', {
                    labels: expenseLabels, datasets: [{ label: 'Expenses', data: expenseValues, backgroundColor: doughnutColors, borderWidth: 0 }]
                }, 'Expense Breakdown');
                
                const totalIncome = income.reduce((sum, t) => sum + t.amount, 0);
                const totalExpense = expenses.reduce((sum, t) => sum + t.amount, 0);
                const chartData = [totalIncome, totalExpense];
                
                this.createChart('income-expense-chart', 'bar', {
                    labels: ['Income', 'Expense'],
                    datasets: [{ 
                        label: 'Amount',
                        data: chartData,
                        backgroundColor: [isDarkMode ? '#34d399' : '#10b981', isDarkMode ? '#fb7185' : '#f43f5e'] 
                    }]
                }, 'Income vs. Expense');
            },
            renderInsights() {
                const insightsContent = document.getElementById('insights-content');
                const allTransactions = App.state.data.transactions || [];
                const carouselNext = document.getElementById('carousel-next');
                const carouselPrev = document.getElementById('carousel-prev');

                if (allTransactions.length < 2) {
                    insightsContent.innerHTML = '<div class="insight-carousel-item active">Add more transactions to see insights.</div>';
                    carouselNext.style.display = 'none';
                    carouselPrev.style.display = 'none';
                    return;
                }

                const { DateTime } = window.luxon;
                const now = DateTime.now();
                const currentMonthTransactions = allTransactions.filter(t => DateTime.fromISO(t.date).month === now.month && DateTime.fromISO(t.date).year === now.year);
                const lastMonth = now.minus({ months: 1 });
                const lastMonthTransactions = allTransactions.filter(t => DateTime.fromISO(t.date).month === lastMonth.month && DateTime.fromISO(t.date).year === lastMonth.year);
                const allExpenses = allTransactions.filter(t => t.type === 'expense');

                const currentMonthTotalExpense = currentMonthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const lastMonthTotalExpense = lastMonthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                const currentMonthTotalIncome = currentMonthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                
                const newInsights = [];

                if (lastMonthTotalExpense > 0) {
                    const diff = currentMonthTotalExpense - lastMonthTotalExpense;
                    const percentageChange = ((diff / lastMonthTotalExpense) * 100).toFixed(1);
                    if (diff > 0) {
                        newInsights.push(`Spending is up by ${this.formatCurrency(diff)} (${percentageChange}%) this month compared to last month.`);
                    } else if (diff < 0) {
                        newInsights.push(`Spending is down by ${this.formatCurrency(Math.abs(diff))} (${Math.abs(percentageChange)}%) this month. Great job!`);
                    }
                }

                const expensesByCategory = currentMonthTransactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
                const sortedCategories = Object.entries(expensesByCategory).sort(([, a], [, b]) => b - a);
                if (sortedCategories.length > 0) {
                    const [topCategory, topAmount] = sortedCategories[0];
                    const totalExpenses = Object.values(expensesByCategory).reduce((sum, amount) => sum + amount, 0);
                    if (totalExpenses > 0) {
                        const percentage = ((topAmount / totalExpenses) * 100).toFixed(1);
                        newInsights.push(`Your top spending category this month is ${topCategory}, accounting for ${percentage}% of your expenses.`);
                    }
                }

                if (currentMonthTotalIncome > 0) {
                    const savingsRate = ((currentMonthTotalIncome - currentMonthTotalExpense) / currentMonthTotalIncome) * 100;
                    if (savingsRate > 0) {
                        newInsights.push(`Your monthly savings rate is currently ${savingsRate.toFixed(1)}%.`);
                    }
                }

                const budgets = App.state.data.budgets || [];
                if (budgets.length > 0) {
                    const overspentBudgets = budgets.filter(b => (expensesByCategory[b.category] || 0) > b.limit);
                    if (overspentBudgets.length > 0) {
                        newInsights.push(`You are over budget on ${overspentBudgets.length} category${overspentBudgets.length > 1 ? 's' : ''}! Review your spending.`);
                    } else {
                        newInsights.push(`All of your budgets are currently on track. Well done!`);
                    }
                }

                const allExpensesByCategory = allExpenses.reduce((acc, t) => {
                    if (!acc[t.category]) acc[t.category] = [];
                    acc[t.category].push(t.amount);
                    return acc;
                }, {});

                for (const category in expensesByCategory) {
                    const categoryHistory = allExpensesByCategory[category];
                    if (categoryHistory.length > 1) {
                        const sum = categoryHistory.reduce((s, a) => s + a, 0);
                        const avg = sum / categoryHistory.length;
                        const currentMonthSpending = expensesByCategory[category];
                        if (currentMonthSpending > avg * 1.5) {
                            newInsights.push(`Your spending in ${category} this month is significantly higher than your historical average.`);
                            break;
                        }
                    }
                }
                
                App.state.insights = newInsights;
                const insightHTML = App.state.insights.map((insight, index) => {
                    const activeClass = index === App.state.currentInsightIndex ? 'active' : '';
                    return `<div class="insight-carousel-item ${activeClass}">${insight}</div>`;
                }).join('');
                
                insightsContent.innerHTML = insightHTML || '<div class="insight-carousel-item active">No new insights yet.</div>';

                if (App.state.insights.length > 1) {
                    carouselNext.style.display = 'block';
                    carouselPrev.style.display = 'block';
                } else {
                    carouselNext.style.display = 'none';
                    carouselPrev.style.display = 'none';
                }
            },
            renderForecast() {
                const allTransactions = App.state.data.transactions || [];
                
                if (allTransactions.length < 3) {
                    document.getElementById('forecast-card').style.display = 'none';
                    return;
                }
                document.getElementById('forecast-card').style.display = 'block';

                const { DateTime } = window.luxon;
                const now = DateTime.now();

                const monthlyData = {};
                for (let i = 0; i < 3; i++) {
                    const month = now.minus({ months: i });
                    const monthKey = month.toFormat('yyyy-MM');
                    monthlyData[monthKey] = { income: 0, expense: 0 };
                }

                allTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));

                let totalIncome = 0;
                let totalExpense = 0;
                let totalMonths = 0;
                
                const recentMonths = {};
                for(let t of allTransactions) {
                    const date = DateTime.fromISO(t.date);
                    const monthKey = date.toFormat('yyyy-MM');
                    if (!recentMonths[monthKey]) {
                        recentMonths[monthKey] = { income: 0, expense: 0 };
                    }
                    if (t.type === 'income') {
                        recentMonths[monthKey].income += t.amount;
                    } else {
                        recentMonths[monthKey].expense += t.amount;
                    }
                }

                const lastThreeMonths = Object.keys(recentMonths).sort().slice(-3);
                for(let monthKey of lastThreeMonths) {
                    totalIncome += recentMonths[monthKey].income;
                    totalExpense += recentMonths[monthKey].expense;
                    totalMonths++;
                }
                const avgMonthlyNet = (totalMonths > 0) ? (totalIncome - totalExpense) / totalMonths : 0;
                const forecastMonths = 6;
                let forecastLabels = [];
                let forecastValues = [];
                
                let currentBalance = (App.state.data.transactions || []).reduce((acc, t) => acc + (t.type === 'income' ? t.amount : -t.amount), 0);
                
                for(let i=0; i<forecastMonths; i++) {
                    const futureMonth = now.plus({ months: i });
                    forecastLabels.push(futureMonth.toFormat('MMM yyyy'));
                    if (i > 0) {
                      currentBalance += avgMonthlyNet;
                    }
                    forecastValues.push(currentBalance);
                }

                this.createChart('forecast-chart', 'line', {
                    labels: forecastLabels,
                    datasets: [{
                        label: 'Projected Balance',
                        data: forecastValues,
                        borderColor: App.state.data.settings.darkMode ? '#7dd3fc' : '#3b82f6',
                        backgroundColor: App.state.data.settings.darkMode ? 'rgba(125, 211, 252, 0.2)' : 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                }, 'Financial Forecast');
            },
            createChart(canvasId, type, data, title) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                if (App.state.charts[canvasId]) App.state.charts[canvasId].destroy();
                const ctx = canvas.getContext('2d');
                const options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: title, font: { size: 16, weight: '600' } }
                    }
                };

                if (type === 'doughnut') {
                    delete options.scales;
                } else if (type === 'bar') {
                    options.scales = { y: { beginAtZero: true } };
                }
                
                App.state.charts[canvasId] = new Chart(ctx, { type, data, options });
                this.applyTheme();
            },
            populateFilters() {
                const monthFilter = document.getElementById('month-filter');
                const yearFilter = document.getElementById('year-filter');
                const currentMonth = monthFilter.value;
                const currentYear = yearFilter.value;
                const dates = (App.state.data.transactions || []).map(t => new Date(t.date));
                const years = [...new Set(dates.map(d => d.getFullYear()))].sort((a, b) => b - a);
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                monthFilter.innerHTML = `<option value="all">All Months</option>` + monthNames.map((name, i) => `<option value="${i+1}">${name}</option>`).join('');
                yearFilter.innerHTML = '<option value="all">All Years</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
                monthFilter.value = currentMonth || 'all';
                yearFilter.value = currentYear || 'all';
            },
            getEmptyStateHTML(title, message, buttonId) {
                let buttonHTML = '';
                if(buttonId === 'add-budget-btn-empty') {
                    buttonHTML = `<p style="margin-top: 10px;">Go to the <strong style="color:var(--primary-brand)">Manage</strong> tab to create one.</p>`
                } else if (buttonId) {
                    buttonHTML = `<button id="${buttonId}" class="btn btn-secondary" style="margin-top: 10px;">Create One</button>`;
                }
                return `<div class="empty-state"><div class="empty-state-icon"><svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--secondary-text-color)" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M8 12h8"/><path d="M12 8v8"/></svg></div><h3 style="font-size: 1.2em; font-weight: 600;">${title}</h3><p>${message}</p>${buttonHTML}</div>`;
            },
            formatCurrency(amount) {
                const symbol = App.state.data.settings.currencySymbol || '$';
                return new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(amount || 0).replace('$', symbol);
            },
            showModal(type, idOrTab) {
                App.state.currentEditId = (type === 'transaction' && typeof idOrTab === 'string') ? parseFloat(idOrTab) : null;
                const modal = document.getElementById('modal-overlay');
                const modalTitle = document.getElementById('modal-title');
                const modalBody = document.getElementById('modal-body');
                let content, title;
                switch(type) {
                    case 'transaction':
                        const isEdit = App.state.currentEditId !== null;
                        const t = isEdit ? (App.state.data.transactions || []).find(t => t.id === App.state.currentEditId) : {};
                        title = isEdit ? 'Edit Transaction' : 'Add Transaction';
                        content = this.getTransactionFormHTML(t);
                        break;
                    case 'manage': 
                        title = 'Manage Data'; 
                        content = this.getManageContentHTML(); 
                        break;
                    case 'settings': 
                        title = 'Settings'; 
                        content = this.getSettingsModalHTML(); 
                        break;
                }
                modalTitle.textContent = title;
                modalBody.innerHTML = content;
                this.bindModalEvents(type, idOrTab);
                modal.classList.add('visible');
            },
            hideModal() {
                document.getElementById('modal-overlay').classList.remove('visible');
                App.state.currentEditId = null;
            },
            showConfirmationModal(message, onConfirm) {
                const modal = document.getElementById('confirmation-modal-overlay');
                document.getElementById('confirmation-message').textContent = message;
                App.state.onConfirm = onConfirm;
                modal.classList.add('visible');
            },
            hideConfirmationModal() {
                document.getElementById('confirmation-modal-overlay').classList.remove('visible');
            },
            showAddGoalSavingsModal(goalId) {
                const goal = App.state.data.goals.find(g => g.id === goalId);
                if (!goal) return;
                
                const modal = document.getElementById('add-goal-savings-modal-overlay');
                document.getElementById('goal-name-display').textContent = goal.name;
                document.getElementById('add-goal-savings-form').dataset.goalId = goalId;
                document.getElementById('add-goal-savings-amount').value = '';
                modal.classList.add('visible');
            },
            hideAddGoalSavingsModal() {
                document.getElementById('add-goal-savings-modal-overlay').classList.remove('visible');
            },
            showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },
            bindModalEvents(type, activeTab) {
                const modalBody = document.getElementById('modal-body');
                if (type === 'transaction') {
                    const form = modalBody.querySelector('#transaction-form');
                    const typeSelect = form.querySelector('#type');
                    const goalsContainer = form.querySelector('#goal-allocation-container');
                    
                    const toggleGoalAllocation = () => {
                        if (!goalsContainer) return; 
                        if (typeSelect.value === 'income' && (App.state.data.goals && App.state.data.goals.length > 0)) {
                            goalsContainer.style.display = 'block';
                        } else {
                            goalsContainer.style.display = 'none';
                        }
                    };

                    typeSelect.addEventListener('change', toggleGoalAllocation);
                    toggleGoalAllocation();

                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const form = e.target;
                        const originalAmount = parseFloat(form.amount.value);
                        let finalTransactionAmount = originalAmount;

                        const goalId = form['goal-allocation-select']?.value;
                        const allocationAmount = parseFloat(form['goal-allocation-amount']?.value || 0);

                        if (form.type.value === 'income' && goalId && allocationAmount > 0) {
                            if (allocationAmount > originalAmount) {
                                UI.showToast('Allocation amount cannot exceed income amount.', 'error');
                                return;
                            }
                            
                            const goalToUpdate = App.state.data.goals.find(g => g.id.toString() === goalId);
                            if (goalToUpdate) {
                                goalToUpdate.current += allocationAmount;
                                finalTransactionAmount -= allocationAmount;
                                UI.showToast(`Allocated ${UI.formatCurrency(allocationAmount)} to ${goalToUpdate.name}`, 'success');
                            }
                        }

                        const newTransaction = {
                            id: App.state.currentEditId || Date.now() + Math.random(),
                            type: form.type.value,
                            amount: finalTransactionAmount,
                            category: form.category.value,
                            description: form.description.value,
                            date: form.date.value
                        };
                        
                        if (App.state.currentEditId) {
                            App.state.data.transactions = App.state.data.transactions.map(t => t.id === newTransaction.id ? newTransaction : t);
                        } else {
                            App.state.data.transactions.push(newTransaction);
                        }
                        if (!App.state.data.categories.includes(newTransaction.category) && newTransaction.category) {
                            App.state.data.categories.push(newTransaction.category);
                        }
                        FirebaseStore.save();
                        this.hideModal();
                        this.showToast(App.state.currentEditId ? 'Transaction Updated' : 'Transaction Added', 'success');
                    });
                } else if (type === 'manage') {
                    this.bindManageViewEvents(modalBody, activeTab);
                } else if (type === 'settings') {
                    const fileInput = modalBody.querySelector('#profile-picture-input');
                    const previewImg = modalBody.querySelector('#settings-avatar-preview');
                    const reminderInput = modalBody.querySelector('#reminder-days-input');

                    fileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (!file || !file.type.startsWith('image/')) return;

                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const base64String = event.target.result;

                            if (base64String.length > 750000) { 
                                UI.showToast('Image is too large (max 0.75MB).', 'error');
                                return;
                            }

                            previewImg.src = base64String;
                            App.state.data.settings.profilePicture = base64String;
                            FirebaseStore.save();
                            UI.showToast('Profile picture updated!', 'success');
                        };
                        reader.readAsDataURL(file);
                    });
                    
                    reminderInput.addEventListener('change', (e) => {
                        const days = parseInt(e.target.value);
                        if (!isNaN(days) && days > 0) {
                            App.state.data.settings.reminderDays = days;
                            FirebaseStore.save();
                            UI.showToast('Reminder updated', 'success');
                        }
                    });

                    modalBody.querySelector('#currency-symbol-input-modal').addEventListener('change', (e) => {
                        App.state.data.settings.currencySymbol = e.target.value;
                        FirebaseStore.save();
                        UI.showToast('Currency updated', 'success');
                    });
                    modalBody.querySelector('#dark-mode-toggle-modal').addEventListener('change', (e) => {
                        App.state.data.settings.darkMode = e.target.checked;
                        FirebaseStore.save();
                        UI.applyTheme();
                        UI.showToast('Theme updated', 'success');
                    });
                }
            },
            bindManageViewEvents(container, activeTab) {
                const tabs = container.querySelectorAll('.tab-btn');
                const contents = container.querySelectorAll('.tab-content');
                tabs.forEach(tab => tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    container.querySelector(`#${tab.dataset.tab}`).classList.add('active');
                }));
                if (typeof activeTab === 'string') {
                    container.querySelector(`.tab-btn[data-tab="${activeTab}"]`)?.click();
                }
                
                const categoryForm = container.querySelector('#category-form');
                if (categoryForm) {
                    categoryForm.addEventListener('submit', e => {
                        e.preventDefault();
                        const input = e.target.elements['new-category'];
                        const newCat = input.value.trim();
                        if (newCat && !App.state.data.categories.includes(newCat)) {
                            App.state.data.categories.push(newCat);
                            FirebaseStore.save();
                            this.showToast('Category Added', 'success');
                        }
                        input.value = '';
                    });
                }
                
                const categoryList = container.querySelector('#category-list-manage');
                if(categoryList) {
                    categoryList.addEventListener('click', e => {
                        if (e.target.closest('.delete-category-btn')) {
                            const catToDelete = e.target.closest('.delete-category-btn').dataset.category;
                            this.showConfirmationModal(`Delete category "${catToDelete}"?`, () => {
                                App.state.data.categories = App.state.data.categories.filter(c => c !== catToDelete);
                                FirebaseStore.save();
                                this.showToast('Category Deleted', 'success');
                            });
                        }
                    });
                }

                const budgetForm = container.querySelector('#budget-form');
                if(budgetForm) {
                    budgetForm.addEventListener('submit', e => {
                        e.preventDefault();
                        const category = e.target.elements['budget-category'].value;
                        const limit = parseFloat(e.target.elements['budget-limit'].value);
                        if (isNaN(limit) || limit <= 0) {
                            this.showToast('Please enter a valid budget limit.', 'error'); return;
                        }
                        const existing = (App.state.data.budgets || []).find(b => b.category === category);
                        if (existing) {
                            existing.limit = limit;
                            this.showToast('Budget Updated', 'success');
                        } else {
                            if(!App.state.data.budgets) App.state.data.budgets = [];
                            App.state.data.budgets.push({ category, limit, id: Date.now() });
                            this.showToast('Budget Saved', 'success');
                        }
                        FirebaseStore.save();
                        e.target.reset();
                    });
                }
                
                const budgetList = container.querySelector('#budget-list-manage');
                if(budgetList) {
                    budgetList.addEventListener('click', e => {
                        if (e.target.closest('.delete-budget-btn')) {
                            const id = parseFloat(e.target.closest('.delete-budget-btn').dataset.id);
                            this.showConfirmationModal(`Delete this budget?`, () => {
                                App.state.data.budgets = App.state.data.budgets.filter(b => b.id !== id);
                                FirebaseStore.save();
                                this.showToast('Budget Deleted', 'success');
                            });
                        }
                    });
                }

                const goalForm = container.querySelector('#goal-form');
                if(goalForm) {
                     goalForm.addEventListener('submit', e => {
                        e.preventDefault();
                        const target = parseFloat(e.target.elements['goal-target'].value);
                        const current = parseFloat(e.target.elements['goal-current'].value);
                        if (isNaN(target) || isNaN(current) || target <= 0) {
                            this.showToast('Please enter valid goal amounts.', 'error'); return;
                        }
                        const newGoal = { id: Date.now(), name: e.target.elements['goal-name'].value, target: target, current: current };
                        if(!App.state.data.goals) App.state.data.goals = [];
                        App.state.data.goals.push(newGoal);
                        FirebaseStore.save();
                        e.target.reset();
                        this.showToast('Goal Added', 'success');
                    });
                }
               
                const goalList = container.querySelector('#goal-list-manage');
                if(goalList) {
                    goalList.addEventListener('click', e => {
                        if (e.target.closest('.delete-goal-btn')) {
                            const id = parseFloat(e.target.closest('.delete-goal-btn').dataset.id);
                            this.showConfirmationModal(`Delete this goal?`, () => {
                                App.state.data.goals = App.state.data.goals.filter(g => g.id !== id);
                                FirebaseStore.save();
                                this.showToast('Goal Deleted', 'success');
                            });
                        } else if (e.target.closest('.add-savings-btn')) {
                            const goalId = parseFloat(e.target.closest('.add-savings-btn').dataset.id);
                            UI.showAddGoalSavingsModal(goalId);
                        }
                    });
                }
                
                const recurringForm = container.querySelector('#recurring-form');
                if (recurringForm) {
                    recurringForm.addEventListener('submit', e => {
                        e.preventDefault();
                        const form = e.target;
                        const amount = parseFloat(form.amount.value);
                        const day = parseInt(form.day.value);
                        if (isNaN(amount) || amount <= 0 || isNaN(day) || day < 1 || day > 31) {
                            this.showToast('Please enter valid recurring transaction details.', 'error'); return;
                        }
                        if(!App.state.data.recurringTransactions) App.state.data.recurringTransactions = [];
                        App.state.data.recurringTransactions.push({ id: Date.now(), type: form.type.value, amount: amount, category: form.category.value, description: form.description.value, day: day });
                        FirebaseStore.save();
                        form.reset();
                        this.showToast('Recurring Transaction Added', 'success');
                    });
                }

                const recurringList = container.querySelector('#recurring-list-manage');
                if (recurringList) {
                    recurringList.addEventListener('click', e => {
                        if (e.target.closest('.delete-recurring-btn')) {
                            const id = parseFloat(e.target.closest('.delete-recurring-btn').dataset.id);
                            this.showConfirmationModal(`Delete this recurring transaction?`, () => {
                                App.state.data.recurringTransactions = App.state.data.recurringTransactions.filter(rt => rt.id !== id);
                                FirebaseStore.save();
                                this.showToast('Recurring Transaction Deleted', 'success');
                            });
                        }
                    });
                }
                
                const exportBtn = container.querySelector('#export-csv-btn');
                if (exportBtn) exportBtn.addEventListener('click', this.exportCSV);
                
                const importBtn = container.querySelector('#import-csv-btn');
                const importFile = container.querySelector('#import-csv-file');
                if(importBtn && importFile) {
                    importBtn.addEventListener('click', () => importFile.click());
                    importFile.addEventListener('change', this.importCSV);
                }
            },
            getTransactionFormHTML(t = {}) {
                const today = new Date().toISOString().split('T')[0];
                const categoryOptions = (App.state.data.categories || []).map(c => `<option value="${c}"></option>`).join('');
                
                const goals = App.state.data.goals || [];
                const goalOptions = goals.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
                const hasGoals = goals.length > 0;
                
                return `
                    <form id="transaction-form" class="modal-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="type">Type</label>
                                <select id="type" class="form-select">${['expense', 'income'].map(v => `<option value="${v}" ${t.type === v ? 'selected' : ''}>${v.charAt(0).toUpperCase() + v.slice(1)}</option>`).join('')}</select>
                            </div>
                            <div class="form-group">
                                <label for="amount">Amount</label>
                                <input type="number" id="amount" class="form-input" step="0.01" value="${t.amount || ''}" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="category">Category</label>
                            <input list="category-list-datalist" id="category" class="form-input" value="${t.category || ''}" required>
                            <datalist id="category-list-datalist">${categoryOptions}</datalist>
                        </div>
                        <div class="form-group">
                            <label for="description">Description</label>
                            <input type="text" id="description" class="form-input" value="${t.description || ''}">
                        </div>
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" class="form-input" value="${t.date || today}" required>
                        </div>
                        ${hasGoals ? `
                            <div id="goal-allocation-container" class="goal-allocation-section" style="display: none;">
                                <h3>Allocate to a Goal</h3>
                                <div class="form-group">
                                    <label for="goal-allocation-select">Select Goal</label>
                                    <select id="goal-allocation-select" name="goal-allocation-select" class="form-select">
                                        <option value="">None</option>
                                        ${goalOptions}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="goal-allocation-amount">Amount to Allocate</label>
                                    <input type="number" id="goal-allocation-amount" name="goal-allocation-amount" class="form-input" step="0.01" value="0" min="0">
                                </div>
                            </div>
                        ` : ''}
                        <div class="modal-buttons">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('modal-overlay').classList.remove('visible')">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                `;
            },
            getManageContentHTML() {
                const categoriesHTML = (App.state.data.categories || []).map(c => `<div class="list-item"><span>${c}</span><button class="btn btn-danger delete-category-btn" data-category="${c}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>`).join('');
                const budgetsHTML = (App.state.data.budgets || []).map(b => `<div class="list-item"><span>${b.category}: ${this.formatCurrency(b.limit)}</span><button class="btn btn-danger delete-budget-btn" data-id="${b.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>`).join('');
                const goalsHTML = (App.state.data.goals || []).map(g => `
                    <div class="list-item">
                        <span>${g.name}: ${this.formatCurrency(g.current)} / ${this.formatCurrency(g.target)}</span>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn add-savings-btn" title="Add Savings" data-id="${g.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            </button>
                            <button class="btn delete-goal-btn" title="Delete Goal" data-id="${g.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                    </div>`).join('');
                const recurringHTML = (App.state.data.recurringTransactions || []).map(rt => `<div class="list-item"><span>${rt.description} (${this.formatCurrency(rt.amount)}) on day ${rt.day}</span><button class="btn btn-danger delete-recurring-btn" data-id="${rt.id}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div>`).join('');
                const categoryOptions = (App.state.data.categories || []).map(c => `<option value="${c}"></option>`).join('');

                const categoryIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5.5 8.5L7.5 10.5L10.5 7.5L8.5 5.5L5.5 8.5Z"/><path d="M9.5 12.5L11.5 14.5L14.5 11.5L12.5 9.5L9.5 12.5Z"/><path d="M13.5 16.5L15.5 18.5L18.5 15.5L16.5 13.5L13.5 16.5Z"/><path d="M12.5 2L10.5 4L13.5 7L15.5 5L12.5 2Z"/><path d="M6.5 14L4.5 16L7.5 19L9.5 17L6.5 14Z"/><path d="M16.5 7L14.5 9L17.5 12L19.5 10L16.5 7Z"/></svg>`;
                const budgetIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 7v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2z"/><line x1="12" y1="19" x2="12" y2="21"/><line x1="12" y1="3" x2="12" y2="5"/></svg>`;
                const goalIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21.6c-4.4 0-8-3.6-8-8c0-3.6 2.4-6.6 6-7.7v-2.3c0-0.552 0.448-1 1-1h2c0.552 0 1 0.448 1 1v2.3c3.6 1.1 6 4.1 6 7.7c0 4.4-3.6 8-8 8z"/><line x1="12" y1="13" x2="12" y2="17"/><path d="M12 13v-5"/></svg>`;
                const recurringIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12v3a6 6 0 0 1-12 0v-3"/><path d="M3 12v-3a6 6 0 0 1 12 0v3"/></svg>`;
                const dataIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`;

                return `
                    <div class="view-tabs">
                        <button class="tab-btn active" data-tab="categories">${categoryIcon} Categories</button>
                        <button class="tab-btn" data-tab="budgets">${budgetIcon} Budgets</button>
                        <button class="tab-btn" data-tab="goals">${goalIcon} Goals</button>
                        <button class="tab-btn" data-tab="recurring">${recurringIcon} Recurring</button>
                        <button class="tab-btn" data-tab="data">${dataIcon} Data</button>
                    </div>
                    <div id="categories" class="tab-content active">
                        <div class="manage-form">
                            <form id="category-form">
                                <h3 style="margin-bottom:12px;">Add New Category</h3>
                                <input type="text" name="new-category" class="form-input" placeholder="e.g., Subscriptions" required>
                                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:8px;">Add Category</button>
                            </form>
                        </div>
                        <div class="manage-list">
                            <h3 style="margin-top:20px;">Existing Categories</h3>
                            <div id="category-list-manage">${categoriesHTML || '<p>No categories yet.</p>'}</div>
                        </div>
                    </div>
                    <div id="budgets" class="tab-content">
                        <div class="manage-form">
                            <h3 style="margin-bottom:12px;">Set a New Budget</h3>
                            <form id="budget-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Category</label>
                                        <input list="category-list-datalist" name="budget-category" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Limit</label>
                                        <input type="number" name="budget-limit" class="form-input" step="0.01" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Set Budget</button>
                            </form>
                        </div>
                        <div class="manage-list">
                            <h3 style="margin-top:20px;">Current Budgets</h3>
                            <div id="budget-list-manage">${budgetsHTML || '<p>No budgets set.</p>'}</div>
                        </div>
                    </div>
                    <div id="goals" class="tab-content">
                        <div class="manage-form">
                            <h3 style="margin-bottom:12px;">Set a New Goal</h3>
                            <form id="goal-form">
                                <div class="form-group">
                                    <label>Goal Name</label>
                                    <input type="text" name="goal-name" class="form-input" placeholder="e.g., Vacation fund" required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Target Amount</label>
                                        <input type="number" name="goal-target" class="form-input" step="0.01" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Current Amount</label>
                                        <input type="number" name="goal-current" class="form-input" step="0.01" required value="0">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Goal</button>
                            </form>
                        </div>
                        <div class="manage-list">
                            <h3 style="margin-top:20px;">Current Goals</h3>
                            <div id="goal-list-manage">${goalsHTML || '<p>No goals set.</p>'}</div>
                        </div>
                    </div>
                    <div id="recurring" class="tab-content">
                        <div class="manage-form">
                            <h3 style="margin-bottom:12px;">Add Recurring Transaction</h3>
                            <form id="recurring-form">
                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" name="description" class="form-input" placeholder="e.g., Monthly Rent" required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Type</label>
                                        <select name="type" class="form-select"><option value="expense">Expense</option><option value="income">Income</option></select>
                                    </div>
                                    <div class="form-group">
                                        <label>Amount</label>
                                        <input type="number" name="amount" class="form-input" step="0.01" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Category</label>
                                        <input list="category-list-datalist" name="category" class="form-input" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Day of Month</label>
                                        <input type="number" name="day" class="form-input" min="1" max="31" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Recurring</button>
                            </form>
                        </div>
                        <div class="manage-list">
                            <h3 style="margin-top:20px;">Recurring Transactions</h3>
                            <div id="recurring-list-manage">${recurringHTML || '<p>No recurring transactions set.</p>'}</div>
                        </div>
                    </div>
                    <div id="data" class="tab-content">
                        <h3 style="margin-bottom: 20px;">Import/Export Data</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <button id="export-csv-btn" class="btn btn-secondary">Export CSV</button>
                            <button id="import-csv-btn" class="btn btn-secondary">Import CSV</button>
                            <input type="file" id="import-csv-file" accept=".csv" style="display: none;">
                        </div>
                    </div>
                    <datalist id="category-list-datalist">${categoryOptions}</datalist>
                `;
            },
            getSettingsModalHTML() {
                const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMCAyMXYtMmE0IDQgMCAwIDAtNC00SDhhNCA0IDAgMCAwLTQgNHYyIj48L3BhdGg+PGNpcmNsZSBjeD0iMTIiIGN5PSI3IiByPSI0Ij48L2NpcmNsZT48L3N2Zz4=';
                const currentAvatar = App.state.data.settings.profilePicture || defaultAvatar;
                const currentCurrencySymbol = App.state.data.settings.currencySymbol || '$';
                const isDarkModeChecked = App.state.data.settings.darkMode ? 'checked' : '';
                const reminderDays = App.state.data.settings.reminderDays || 3;
                return `
                    <div class="form-group" style="text-align: center; margin-bottom: 24px;">
                        <label for="profile-picture-input">
                            <div class="user-avatar" style="width: 80px; height: 80px; margin: 0 auto 12px; cursor: pointer;">
                                <img id="settings-avatar-preview" src="${currentAvatar}" alt="Avatar Preview">
                            </div>
                            <span class="btn btn-secondary">Change Picture</span>
                        </label>
                        <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
                    </div>
                    <hr style="border: none; border-top: 1px solid var(--border-color); margin-bottom: 24px;">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label for="currency-symbol-input-modal">Currency Symbol</label>
                        <input type="text" id="currency-symbol-input-modal" class="form-input" value="${currentCurrencySymbol}">
                    </div>
                     <div class="form-group" style="margin-bottom: 20px;">
                        <label for="reminder-days-input">Upcoming Bill Reminder (days)</label>
                        <input type="number" id="reminder-days-input" class="form-input" value="${reminderDays}" min="1" max="30">
                    </div>
                    <div class="theme-switch-wrapper">
                        <label for="dark-mode-toggle-modal">Dark Mode</label>
                        <label class="theme-switch">
                            <input type="checkbox" id="dark-mode-toggle-modal" ${isDarkModeChecked}>
                            <span class="slider"></span>
                        </label>
                    </div>
                `;
            },
            renderPeriodDisplay() {
                const monthFilter = document.getElementById('month-filter');
                const yearFilter = document.getElementById('year-filter');
                const monthVal = monthFilter.value;
                const yearVal = yearFilter.value;
                let periodText = 'For All Time';
                if (yearVal !== 'all') {
                    periodText = `For ${yearVal}`;
                    if (monthVal !== 'all') {
                        const monthName = monthFilter.options[monthFilter.selectedIndex].text;
                        periodText = `For ${monthName} ${yearVal}`;
                    }
                }
                document.getElementById('period-display').textContent = periodText;
                document.getElementById('history-period-display').textContent = periodText;
            },
            exportCSV() {
                let csvContent = "data:text/csv;charset=utf-8,Date,Type,Category,Description,Amount\n";
                App.state.data.transactions.forEach(t => {
                    const description = t.description ? `"${t.description.replace(/"/g, '""')}"` : '""';
                    const row = [t.date, t.type, t.category, description, t.amount].join(",");
                    csvContent += row + "\r\n";
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "transactions.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                UI.showToast('Data exported successfully', 'success');
            },
            importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const newTransactions = [];
                    const rows = text.split(/\r?\n/).slice(1);
                    rows.forEach(row => {
                        const columns = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                        if (columns && columns.length >= 5) {
                            const [date, type, category, description, amount] = columns.map(c => c.replace(/^"|"$/g, '').trim());
                            if (date && type && category && amount) {
                                const parsedDate = window.luxon.DateTime.fromISO(date).isValid ? date : null;
                                const parsedAmount = parseFloat(amount);
                                const parsedType = ['income', 'expense'].includes(type.toLowerCase()) ? type.toLowerCase() : null;
                                if (parsedDate && parsedAmount && parsedType) {
                                    newTransactions.push({
                                        id: Date.now() + Math.random(),
                                        date: parsedDate,
                                        type: parsedType,
                                        category: category,
                                        description: description,
                                        amount: parsedAmount
                                    });
                                }
                            }
                        }
                    });
                    if (newTransactions.length > 0) {
                        UI.showConfirmationModal(`Found ${newTransactions.length} transactions to import. Would you like to add them?`, () => {
                            App.state.data.transactions.push(...newTransactions);
                            FirebaseStore.save();
                            UI.showToast(`${newTransactions.length} transactions imported.`, 'success');
                        });
                    } else {
                        UI.showToast('No valid transactions found in file. Please check the format (Date,Type,Category,Description,Amount)', 'error');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }
        };
        const style = document.createElement('style');
        style.innerHTML = `
            .toast.error {
                background-color: var(--accent-rose);
            }
        `;
        document.head.appendChild(style);

        await App.init();
    });
</script>

</body>
</html>

